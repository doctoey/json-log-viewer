<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Log Viewer PROMAX</title>
    <!-- Use Inter font for UI and JetBrains Mono for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Twitter (X) Dim + Pink Theme */
        --bg: #15202b; /* Twitter Dim BG */
        --panel: #192734; /* Twitter Dim Card */
        --border: #38444d; /* Twitter Dim Border */
        --text-primary: #f7f9f9;
        --text-secondary: #8b98a5;

        --accent: #f91880; /* Twitter Pink */
        --accent-hover: #e01172;

        --success: #00ba7c;
        --error: #f91880;
        --warning: #ffd400;

        /* Syntax Highlighting */
        --sh-key: #ff80ab; /* Pastel Pink */
        --sh-string: #1d9bf0; /* Twitter Blue */
        --sh-number: #ffd400; /* Twitter Yellow */
        --sh-boolean: #00ba7c; /* Option 1: Green (Twitter Success) */
        /* --sh-boolean: #f45d22; Option 2: Orange (High Contrast) */
        /* --sh-boolean: #00e5ff; Option 3: Neon Cyan (Cyberpunk) */
        /* --sh-boolean: #bf5af2; Option 4: Purple (Previous) */
        /* --sh-boolean: #f91880; Option 5: Hot Pink (Previous) */
        --sh-null: #8b98a5; /* Muted Blue-Gray */

        --glass-bg: rgba(21, 32, 43, 0.95);
      }

      * {
        box-sizing: border-box;
        outline: none;
      }

      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg);
        color: var(--text-primary);
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg);
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 5px;
        border: 2px solid var(--bg);
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 24px;
        width: 100%;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      /* Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        margin: 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(
          90deg,
          var(--text-primary),
          var(--text-secondary)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .pro-badge {
        font-size: 12px;
        background: var(--accent);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        -webkit-text-fill-color: initial; /* Fix visibility issue */
        text-shadow: none;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(122, 162, 247, 0.3);
      }

      /* Main Grid */
      .main-grid {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        flex: 1;
        min-height: 0; /* Important for scroll */
      }

      /* Panels */
      .panel {
        background: var(--panel);
        border-radius: 16px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .panel-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.02);
      }

      .panel-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .panel-body {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      /* Inputs */
      .input-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      textarea {
        flex: 1;
        width: 100%;
        background: transparent;
        border: none;
        color: var(--text-primary);
        padding: 16px;
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: none;
      }
      textarea::placeholder {
        color: rgba(139, 152, 165, 0.4);
      }

      .drop-overlay {
        position: absolute;
        inset: 0;
        background: rgba(29, 155, 240, 0.1);
        backdrop-filter: blur(4px);
        display: none; /* Flex when active */
        justify-content: center;
        align-items: center;
        border: 2px dashed var(--accent);
        pointer-events: none;
      }
      .drag-active .drop-overlay {
        display: flex;
      }

      /* Buttons & Tools */
      .btn {
        height: 32px;
        padding: 0 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
        border: none;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        border: 1px solid var(--border);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      .btn-icon {
        padding: 0;
        width: 32px;
        justify-content: center;
      }

      /* Search Bar */
      .search-box {
        position: relative;
        flex: 1;
        max-width: 300px;
      }
      .search-box input {
        width: 100%;
        height: 32px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0 32px 0 12px;
        color: var(--text-primary);
        font-size: 13px;
      }
      .search-box svg {
        position: absolute;
        right: 10px;
        top: 8px;
        color: var(--text-secondary);
        pointer-events: none;
      }

      /* JSON Tree Viewer */
      .json-tree {
        padding: 16px;
        overflow: auto;
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
        padding-bottom: 50px;
      }

      .node {
        display: flex;
        flex-direction: column;
      }
      .line {
        display: flex;
        align-items: flex-start;
      }

      .toggle {
        cursor: pointer;
        user-select: none;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: transform 0.15s ease;
      }
      .toggle:hover {
        color: var(--text-primary);
      }
      .toggle.collapsed {
        transform: rotate(-90deg);
      }
      .toggle.leaf {
        visibility: hidden;
      }

      .key {
        color: var(--sh-key);
        margin-right: 6px;
        cursor: pointer;
      }
      .key:hover {
        text-decoration: underline;
        opacity: 0.8;
      }

      .separator {
        color: var(--text-secondary);
        margin-right: 6px;
      }

      .value {
        cursor: pointer;
        padding: 0 4px;
        border-radius: 4px;
        transition: background 0.1s;
      }
      .value:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .string {
        color: var(--sh-string);
        word-break: break-all;
      }
      .number {
        color: var(--sh-number);
      }
      .boolean {
        color: var(--sh-boolean);
      }
      .null {
        color: var(--sh-null);
      }

      .meta {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 12px;
        margin-left: 8px;
      }

      .hidden-node {
        display: none;
      }
      .match-highlight {
        background: rgba(255, 212, 0, 0.3);
        color: #fff;
        border-radius: 2px;
      }

      /* Toast Notification */
      #toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--panel);
        border: 1px solid var(--border);
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 0;
      }
      #toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      #toast.success i {
        color: var(--success);
      }
      #toast.error i {
        color: var(--error);
      }

      /* Loading State */
      .loader {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: none;
      }
      .loading .loader {
        display: block;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        font-size: 14px;
        opacity: 0.5;
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
          gap: 16px;
        }
        .container {
          padding: 8px;
          height: auto;
        }
        body {
          height: auto;
        }
        textarea {
          height: 160px;
          min-height: 120px;
        }
        .panel {
          border-radius: 10px;
        }
      }

      @media (max-width: 600px) {
        .container {
          padding: 2px;
        }
        .main-grid {
          gap: 8px;
        }
        .panel-header,
        .panel-body {
          padding: 8px !important;
        }
        .json-tree {
          padding: 8px;
          font-size: 12px;
        }
        .btn,
        .btn-primary,
        .btn-secondary {
          font-size: 12px;
          height: 28px;
          padding: 0 10px;
        }
        h1 {
          font-size: 18px;
        }
      }

      .meta-val {
        color: var(--text-secondary);
        font-size: 11px;
        margin-left: 8px;
        background: rgba(255, 255, 255, 0.05);
        padding: 2px 6px;
        border-radius: 4px;
        user-select: text;
        cursor: text;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <rect
              x="3"
              y="3"
              width="18"
              height="18"
              rx="6"
              fill="#1d9bf0"
              fill-opacity="0.2"
            />
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              stroke="#1d9bf0"
              stroke-width="2"
            />
            <path d="M14 2v6h6" stroke="#1d9bf0" stroke-width="2" />
            <path
              d="M8 13h8"
              stroke="#1d9bf0"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M8 17h5"
              stroke="#1d9bf0"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          JSON Log Viewer
          <span class="pro-badge">PROMAX</span>
        </h1>
        <div style="display: flex; gap: 8px">
          <a
            href="https://github.com/doctoey/json-log-viewer"
            target="_blank"
            class="btn btn-secondary"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              style="margin-right: 6px"
            >
              <path
                d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            GitHub
          </a>
        </div>
      </header>

      <div class="main-grid">
        <!-- LEFT PANEL: INPUT -->
        <section class="panel">
          <div class="panel-header">
            <span class="panel-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              Input
            </span>
            <div class="flex gap-2" style="display: flex; gap: 8px">
              <div class="loader" id="spinner"></div>
              <button
                class="btn btn-secondary btn-icon"
                onclick="App.clear()"
                title="Clear"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body input-wrapper" id="dropZone">
            <textarea
              id="inputData"
              placeholder="Paste JSON, Drag & Drop file, or type here..."
            ></textarea>
            <div class="drop-overlay">
              <span style="color: var(--accent); font-weight: 600"
                >Drop JSON File Here</span
              >
            </div>

            <!-- Quick Actions Toolbar at bottom of input -->
            <div
              style="
                padding: 12px;
                border-top: 1px solid var(--border);
                background: rgba(0, 0, 0, 0.1);
                display: flex;
                gap: 8px;
                justify-content: flex-end;
              "
            >
              <button class="btn btn-secondary" onclick="App.formatInput()">
                Format
              </button>
              <button class="btn btn-primary" onclick="App.process()">
                Process
              </button>
            </div>
          </div>
        </section>

        <!-- RIGHT PANEL: OUTPUT -->
        <section class="panel">
          <div class="panel-header">
            <span class="panel-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M2 12h20M2 12l5-5m-5 5 5 5"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              Viewer
            </span>

            <div class="search-box">
              <input
                type="text"
                id="searchBox"
                placeholder="Filter keys or values..."
                onkeyup="Viewer.filter(this.value)"
              />
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <circle
                  cx="11"
                  cy="11"
                  r="8"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="m21 21-4.35-4.35"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>

            <div style="display: flex; gap: 8px">
              <button
                class="btn btn-secondary"
                onclick="App.showTypeGen()"
                title="Generate Types (TS/Go)"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M16 18L22 12L16 6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M8 6L2 12L8 18"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="App.download()"
                title="Save as JSON file"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="Viewer.expandAll()"
                title="Expand All"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="Viewer.collapseAll()"
                title="Collapse All"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M4 14h6v6M20 10h-6V4M14 10l7-7M10 14l-7 7"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="Utils.copyToClipboard(App.rawJson)"
                title="Copy Raw JSON"
              >
                Copy JSON
              </button>
            </div>
          </div>

          <div class="panel-body" style="background: rgba(0, 0, 0, 0.1)">
            <div id="jsonTree" class="json-tree">
              <div class="empty-state">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  style="margin-bottom: 16px; opacity: 0.5"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                  <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" />
                  <path d="M16 13H8" stroke="currentColor" stroke-width="2" />
                  <path d="M16 17H8" stroke="currentColor" stroke-width="2" />
                  <path d="M10 9H8" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Waiting for input...</span>
              </div>
            </div>
          </div>
          <div
            style="
              padding: 8px 16px;
              border-top: 1px solid var(--border);
              font-size: 12px;
              color: var(--text-secondary);
              display: flex;
              justify-content: space-between;
            "
          >
            <span id="pathDisplay">Path: (Click any item to copy path)</span>
            <span id="itemCount">0 items</span>
          </div>
        </section>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">
      <i id="toastIcon"></i>
      <span id="toastMsg">Notification</span>
    </div>

    <!-- Type Gen Modal -->
    <div
      id="modalOverlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: var(--panel);
          border: 1px solid var(--border);
          border-radius: 16px;
          width: 600px;
          max-width: 90vw;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        "
      >
        <div
          style="
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span style="font-weight: 600; font-size: 16px">Generate Types</span>
          <button
            class="btn btn-secondary btn-icon"
            onclick="
              document.getElementById('modalOverlay').style.display = 'none'
            "
          >
            âœ•
          </button>
        </div>
        <div
          style="
            padding: 12px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.1);
          "
        >
          <button class="btn btn-primary" onclick="App.generateType('ts')">
            TypeScript
          </button>
          <button class="btn btn-secondary" onclick="App.generateType('go')">
            Go Struct
          </button>
        </div>
        <textarea
          id="typeOutput"
          style="
            height: 300px;
            padding: 16px;
            font-family: &quot;JetBrains Mono&quot;;
            font-size: 13px;
            border: none;
            resize: none;
          "
          readonly
        ></textarea>
        <div
          style="
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
          "
        >
          <button
            class="btn btn-secondary"
            onclick="
              Utils.copyToClipboard(document.getElementById('typeOutput').value)
            "
          >
            Copy Code
          </button>
        </div>
      </div>
    </div>

    <style>
      /* ... Existing styles ... */

      /* Virtual Scroll Specific Styles */
      .json-tree {
        position: relative;
        overflow: auto;
        will-change: transform;
        /* Ensure container has height for virtual scroll */
        height: 100%;
        padding-bottom: 0; /* Remove padding that interferes with height calc */
      }

      .virtual-spacer {
        width: 1px;
        /* Height set via JS */
      }

      .v-row {
        position: absolute;
        left: 0;
        right: 0;
        height: 24px; /* Fixed height for performance */
        display: flex;
        align-items: center;
        padding-left: 12px;
        white-space: nowrap;
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        line-height: 24px;
        user-select: text;
      }
      .v-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .v-toggle {
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        user-select: none;
        margin-right: 4px;
        transition: transform 0.1s;
      }
      .v-toggle:hover {
        color: var(--text-primary);
      }
      .v-toggle.rotate {
        transform: rotate(90deg);
      }
      .v-toggle.invisible {
        visibility: hidden;
      }

      .v-key {
        color: var(--sh-key);
        margin-right: 6px;
        cursor: pointer;
      }
      .v-key:hover {
        text-decoration: underline;
      }

      .v-val-string {
        color: var(--sh-string);
      }
      .v-val-number {
        color: var(--sh-number);
      }
      .v-val-boolean {
        color: var(--sh-boolean);
      }
      .v-val-null {
        color: var(--sh-null);
      }

      .v-meta {
        color: var(--text-secondary);
        font-size: 11px;
        margin-left: 8px;
        font-style: italic;
      }

      .search-match {
        background: rgba(255, 212, 0, 0.2);
        border-radius: 2px;
      }

      /* Loading State */
      .loader {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: none;
      }
      .loading .loader {
        display: block;
      }
    </style>

    <!-- Worker Script embedded -->
    <script id="worker-js" type="javascript/worker">
      self.onmessage = function(e) {
        const { id, raw, type } = e.data;

        if (type === 'parse') {
          try {
            // 1. Parse
            let data = parseJSON(raw);
            // 2. Deep Parse
            data = deepParse(data);

            // 3. Return result
            self.postMessage({ id, success: true, data });
          } catch (err) {
            self.postMessage({ id, success: false, error: err.message });
          }
        }
      };

      function parseJSON(str) {
        if (typeof str !== 'string') return str;
        try {
           const parsed = JSON.parse(str);
           if (typeof parsed === 'string') {
             try { return JSON.parse(parsed); } catch { return parsed; }
           }
           return parsed;
        } catch(e) {
             // Fallback: extract JSON from log line
             const start = str.search(/[{}\[]/);
             if (start > -1) {
                 // Simple extraction heuristic
                 let stack = 0;
                 for(let i=start; i<str.length; i++) {
                     if(str[i] === '{' || str[i] === '[') stack++;
                     if(str[i] === '}' || str[i] === ']') stack--;
                     if(stack === 0) {
                         try { return JSON.parse(str.substring(start, i+1)); } catch {}
                         break;
                     }
                 }
             }
             throw new Error("Invalid JSON");
        }
      }

      function deepParse(data) {
          if (typeof data === 'string') {
            const trimmed = data.trim();
            if ((trimmed.startsWith('{') && trimmed.endsWith('}')) ||
                (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
                try {
                    const parsed = JSON.parse(data);
                    return deepParse(parsed);
                } catch (e) { return data; }
            }
            return data;
          }
          if (Array.isArray(data)) return data.map(deepParse);
          if (data && typeof data === 'object') {
              const res = {};
              for(const k in data) res[k] = deepParse(data[k]);
              return res;
          }
          return data;
      }
    </script>

    <script>
      /**
       * Application State
       */
      const App = {
        worker: null,
        data: null,

        init: () => {
          // Init Worker
          const blob = new Blob(
            [document.getElementById("worker-js").textContent],
            { type: "text/javascript" },
          );
          App.worker = new Worker(URL.createObjectURL(blob));
          App.worker.onmessage = App.onWorkerMessage;

          // UI Events
          document
            .getElementById("inputData")
            .addEventListener("paste", () => setTimeout(App.process, 50));

          // Drag & Drop
          const dropZone = document.getElementById("dropZone");
          ["dragenter", "dragover", "dragleave", "drop"].forEach((name) => {
            dropZone.addEventListener(
              name,
              (e) => {
                e.preventDefault();
                e.stopPropagation();
              },
              false,
            );
          });
          dropZone.addEventListener("drop", (e) => {
            const file = e.dataTransfer.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (ev) => {
                document.getElementById("inputData").value = ev.target.result;
                App.process();
              };
              reader.readAsText(file);
            }
          });

          // Restore
          const saved = sessionStorage.getItem("jsonLogViewerData");
          if (saved) {
            document.getElementById("inputData").value = saved;
            App.process();
          }
        },

        process: () => {
          const raw = document.getElementById("inputData").value;
          if (!raw.trim()) return;

          sessionStorage.setItem("jsonLogViewerData", raw); // Auto save
          document.getElementById("spinner").style.display = "block";

          // Offload to Worker
          App.worker.postMessage({ id: Date.now(), type: "parse", raw });
        },

        onWorkerMessage: (e) => {
          document.getElementById("spinner").style.display = "none";
          const { success, data, error } = e.data;

          if (success) {
            App.data = data;
            App.dataString = JSON.stringify(data, null, 2); // Keep for copy/download
            VirtualViewer.setData(data);
            Utils.toast("Processed Successfully");
          } else {
            Utils.toast("Error: " + error, "error");
          }
        },

        formatInput: () => {
          // Main thread format for input box (usually small enough, or user accepts freezing)
          try {
            const val = document.getElementById("inputData").value;
            const o = JSON.parse(val);
            document.getElementById("inputData").value = JSON.stringify(
              o,
              null,
              2,
            );
          } catch (e) {
            Utils.toast("Invalid JSON", "error");
          }
        },

        clear: () => {
          document.getElementById("inputData").value = "";
          sessionStorage.removeItem("jsonLogViewerData");
          VirtualViewer.setData(null);
        },

        download: () => {
          if (!App.dataString) return;
          const blob = new Blob([App.dataString], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "log.json";
          a.click();
        },

        showTypeGen: () => {
          // ... (Keep existing simple logic or remove if unused, omitting for brevity in this focused update)
          Utils.toast(
            "Use the Type Gen button (Not fully moved to worker yet)",
          );
        },
      };

      /**
       * Virtual Viewer Engine
       * Handles Flattening & Rendering specific window of rows
       */
      const VirtualViewer = {
        container: document.getElementById("jsonTree"),
        rowHeight: 24,
        rows: [], // Flattened visible rows
        expanded: new Set(["root"]), // Paths that are expanded
        fullData: null,
        filterQuery: "",

        init: () => {
          VirtualViewer.container.addEventListener(
            "scroll",
            VirtualViewer.renderVisible,
          );
          window.addEventListener("resize", VirtualViewer.renderVisible);
        },

        setData: (data) => {
          VirtualViewer.fullData = data;
          VirtualViewer.expanded = new Set(["root"]);

          if (data) {
            // Auto Expand Level 3 by default (Deeper visibility)
            VirtualViewer.expandToLevel(3);
          } else {
            VirtualViewer.rows = [];
            VirtualViewer.container.innerHTML =
              '<div class="empty-state">Waiting for input...</div>';
          }
        },

        // Flatten the tree into a list of rows based on expansion state
        recalcRows: () => {
          if (!VirtualViewer.fullData) return;

          const list = [];
          // Stack: { key, val, level, path, parentArray }
          const traverse = (key, val, level, path, parentIsArray) => {
            const type = Array.isArray(val)
              ? "array"
              : val === null
                ? "null"
                : typeof val;
            const isObj = type === "object" || type === "array";
            const isEmpty =
              isObj &&
              (Array.isArray(val)
                ? val.length === 0
                : Object.keys(val).length === 0);
            const pathKey = path;

            // Match Logic
            let isMatch = false;
            if (VirtualViewer.filterQuery) {
              isMatch = VirtualViewer.checkMatch(path, key, val);
            }

            list.push({
              path: pathKey,
              key: key,
              val: val,
              level: level,
              type: type,
              isObj: isObj,
              isEmpty: isEmpty,
              parentIsArray: parentIsArray,
              expanded:
                VirtualViewer.expanded.has(pathKey) ||
                !!VirtualViewer.filterQuery, // Auto expand on filter
              isMatch: isMatch,
            });

            // Children
            if (
              isObj &&
              !isEmpty &&
              (VirtualViewer.expanded.has(pathKey) || VirtualViewer.filterQuery)
            ) {
              if (Array.isArray(val)) {
                val.forEach((item, idx) =>
                  traverse(idx, item, level + 1, `${path}[${idx}]`, true),
                );
              } else {
                Object.keys(val).forEach((k) =>
                  traverse(k, val[k], level + 1, `${path}.${k}`, false),
                );
              }
            }
          };

          // Start
          traverse(null, VirtualViewer.fullData, 0, "root", false);

          // Filter
          if (VirtualViewer.filterQuery) {
            VirtualViewer.rows = list.filter((row) =>
              VirtualViewer.checkMatch(row.path, row.key, row.val),
            );
          } else {
            VirtualViewer.rows = list;
          }

          // Update Scroll Height
          const totalHeight =
            VirtualViewer.rows.length * VirtualViewer.rowHeight;
          let spacer = document.getElementById("v-spacer");
          if (!spacer) {
            spacer = document.createElement("div");
            spacer.id = "v-spacer";
            spacer.className = "virtual-spacer";
            VirtualViewer.container.innerHTML = ""; // Clear
            VirtualViewer.container.appendChild(spacer);
          }
          spacer.style.height = totalHeight + "px";

          VirtualViewer.renderVisible();
          document.getElementById("itemCount").textContent =
            `${VirtualViewer.rows.length} Visible Rows`;
        },

        renderVisible: () => {
          if (!VirtualViewer.rows.length) return;

          const scrollTop = VirtualViewer.container.scrollTop;
          const height = VirtualViewer.container.clientHeight;

          // Buffer
          const startIdx = Math.floor(scrollTop / VirtualViewer.rowHeight);
          const endIdx = Math.min(
            VirtualViewer.rows.length,
            Math.ceil((scrollTop + height) / VirtualViewer.rowHeight) + 5,
          );

          // Remove old rows (except spacer)
          const existing = document.querySelectorAll(".v-row");
          existing.forEach((el) => el.remove());

          // Render new chunk
          const fragment = document.createDocumentFragment();

          for (let i = startIdx; i < endIdx; i++) {
            const rowData = VirtualViewer.rows[i];
            const el = VirtualViewer.createRowEl(rowData, i);
            fragment.appendChild(el);
          }

          VirtualViewer.container.appendChild(fragment);
        },

        createRowEl: (row, index) => {
          const div = document.createElement("div");
          div.className = "v-row";
          div.style.top = index * VirtualViewer.rowHeight + "px";
          div.style.paddingLeft = 12 + row.level * 20 + "px";
          if (row.isMatch) div.classList.add("match-highlight");

          const toggle = document.createElement("span");
          toggle.className = "v-toggle";
          if (row.isObj && !row.isEmpty) {
            toggle.textContent = "â–¶";
            if (row.expanded) toggle.classList.add("rotate");
            toggle.onclick = (e) => {
              e.stopPropagation();
              if (VirtualViewer.expanded.has(row.path))
                VirtualViewer.expanded.delete(row.path);
              else VirtualViewer.expanded.add(row.path);
              VirtualViewer.recalcRows();
            };
          } else {
            toggle.classList.add("invisible");
          }
          div.appendChild(toggle);

          if (row.key !== null) {
            const keySpan = document.createElement("span");
            keySpan.className = "v-key";
            keySpan.textContent = row.parentIsArray
              ? `${row.key}: `
              : `"${row.key}": `;
            keySpan.onclick = () => Utils.copyToClipboard(row.key);
            div.appendChild(keySpan);
          }

          if (row.isObj) {
            const meta = document.createElement("span");
            meta.className = "v-meta";
            if (row.type === "array")
              meta.textContent = `Array(${row.val.length})`;
            else meta.textContent = `Object{${Object.keys(row.val).length}}`;
            div.appendChild(meta);
          } else {
            const valSpan = document.createElement("span");
            valSpan.className = `v-val-${row.type}`;
            const txt =
              row.type === "string" ? `"${row.val}"` : String(row.val);
            valSpan.textContent =
              txt.length > 200 ? txt.substring(0, 200) + "..." : txt;
            valSpan.onclick = () => Utils.copyToClipboard(String(row.val));
            div.appendChild(valSpan);

            const smart = Utils.detectSmartValue(row.val);
            if (smart) {
              const sm = document.createElement("span");
              sm.className = "v-meta";
              sm.style.background = "rgba(255,255,255,0.1)";
              sm.style.padding = "0 4px";
              sm.style.borderRadius = "4px";
              sm.textContent = smart;
              div.appendChild(sm);
            }
          }

          return div;
        },

        checkMatch: (path, key, val) => {
          const q = VirtualViewer.filterQuery;
          if (!q) return true;
          const cleanPath = path.replace("root.", "");
          if (q.includes("=")) {
            const [targetPath, targetVal] = q.split("=").map((s) => s.trim());
            if (targetPath !== "*" && !cleanPath.includes(targetPath))
              return false;
            return String(val).toLowerCase().includes(targetVal.toLowerCase());
          }
          if (q.includes(".") || q.includes("[")) {
            return cleanPath.toLowerCase().includes(q.toLowerCase());
          }
          const kStr = String(key).toLowerCase();
          const vStr = String(val).toLowerCase();
          const qL = q.toLowerCase();
          return kStr.includes(qL) || vStr.includes(qL);
        },

        filter: (val) => {
          VirtualViewer.filterQuery = val.trim();
          VirtualViewer.recalcRows();
        },

        expandToLevel: (depth) => {
          VirtualViewer.expanded.clear();
          const traverse = (d, p, currLvl) => {
            VirtualViewer.expanded.add(p);
            if (currLvl >= depth) return;

            if (d && typeof d === "object") {
              Object.keys(d).forEach((k) => {
                const nextPath = Array.isArray(d) ? `${p}[${k}]` : `${p}.${k}`;
                traverse(d[k], nextPath, currLvl + 1);
              });
            }
          };
          traverse(VirtualViewer.fullData, "root", 0);
          VirtualViewer.recalcRows();
        },

        expandAll: () => {
          // Limit to reasonable depth to prevent hanging
          VirtualViewer.expandToLevel(99);
        },

        toggleAll: (expand) => {
          if (expand) VirtualViewer.expandAll();
          else VirtualViewer.collapseAll();
        },

        collapseAll: () => {
          VirtualViewer.expanded.clear();
          VirtualViewer.expanded.add("root");
          VirtualViewer.recalcRows();
        },
      };

      // Alias for backward compatibility with HTML buttons
      const Viewer = VirtualViewer;

      const Utils = {
        toast: (msg, type = "success") => {
          const t = document.getElementById("toast");
          t.className = `show ${type}`;
          document.getElementById("toastMsg").textContent = msg;
          setTimeout(() => (t.className = ""), 3000);
        },
        copyToClipboard: (txt) => {
          navigator.clipboard.writeText(txt);
          Utils.toast("Copied!");
        },
        detectSmartValue: (val) => {
          if (!val) return null;
          if (
            typeof val === "number" ||
            (typeof val === "string" && /^\d+$/.test(val))
          ) {
            const num = Number(val);
            if (num > 1262304000 && num < 2208988800)
              return "ðŸ•’ " + new Date(num * 1000).toLocaleString();
            if (num > 1262304000000 && num < 2208988800000)
              return "ðŸ•’ " + new Date(num).toLocaleString();
          }
          if (typeof val === "string" && val.length > 5) {
            if (/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(val))
              return "ðŸ”‘ JWT Token";
          }
          return null;
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        App.init();
        VirtualViewer.init();
      });
    </script>
  </body>
</html>
