<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON Log Viewer PROMAX</title>
    <!-- Use Inter font for UI and JetBrains Mono for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Tokyo Night / Cyberpunk Inspired Theme */
        --bg: #1a1b26;
        --panel: #24283b;
        --border: #414868;
        --text-primary: #c0caf5;
        --text-secondary: #787c99;
        --accent: #7aa2f7;
        --accent-hover: #3d59a1;
        --success: #9ece6a;
        --error: #f7768e;
        --warning: #ff9e64;

        /* Vibrant Syntax Highlighting */
        --sh-key: #f7768e; /* Neon Pink */
        --sh-string: #9ece6a; /* Neon Green */
        --sh-number: #ff9e64; /* Neon Orange */
        --sh-boolean: #bb9af7; /* Neon Purple */
        --sh-null: #7dcfff; /* Neon Cyan */

        --glass-bg: rgba(36, 40, 59, 0.85);
      }

      * {
        box-sizing: border-box;
        outline: none;
      }

      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background-color: var(--bg);
        color: var(--text-primary);
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--bg);
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 5px;
        border: 2px solid var(--bg);
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 24px;
        width: 100%;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      /* Header */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        margin: 0;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(
          90deg,
          var(--text-primary),
          var(--text-secondary)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .pro-badge {
        font-size: 12px;
        background: var(--accent);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 8px;
        -webkit-text-fill-color: initial; /* Fix visibility issue */
        text-shadow: none;
        font-weight: 700;
        box-shadow: 0 2px 10px rgba(122, 162, 247, 0.3);
      }

      /* Main Grid */
      .main-grid {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        flex: 1;
        min-height: 0; /* Important for scroll */
      }

      /* Panels */
      .panel {
        background: var(--panel);
        border-radius: 16px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .panel-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.02);
      }

      .panel-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .panel-body {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      /* Inputs */
      .input-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      textarea {
        flex: 1;
        width: 100%;
        background: transparent;
        border: none;
        color: var(--text-primary);
        padding: 16px;
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: none;
      }
      textarea::placeholder {
        color: rgba(139, 152, 165, 0.4);
      }

      .drop-overlay {
        position: absolute;
        inset: 0;
        background: rgba(29, 155, 240, 0.1);
        backdrop-filter: blur(4px);
        display: none; /* Flex when active */
        justify-content: center;
        align-items: center;
        border: 2px dashed var(--accent);
        pointer-events: none;
      }
      .drag-active .drop-overlay {
        display: flex;
      }

      /* Buttons & Tools */
      .btn {
        height: 32px;
        padding: 0 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
        border: none;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        border: 1px solid var(--border);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      .btn-icon {
        padding: 0;
        width: 32px;
        justify-content: center;
      }

      /* Search Bar */
      .search-box {
        position: relative;
        flex: 1;
        max-width: 300px;
      }
      .search-box input {
        width: 100%;
        height: 32px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0 32px 0 12px;
        color: var(--text-primary);
        font-size: 13px;
      }
      .search-box svg {
        position: absolute;
        right: 10px;
        top: 8px;
        color: var(--text-secondary);
        pointer-events: none;
      }

      /* JSON Tree Viewer */
      .json-tree {
        padding: 16px;
        overflow: auto;
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
        padding-bottom: 50px;
      }

      .node {
        display: flex;
        flex-direction: column;
      }
      .line {
        display: flex;
        align-items: flex-start;
      }

      .toggle {
        cursor: pointer;
        user-select: none;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: transform 0.15s ease;
      }
      .toggle:hover {
        color: var(--text-primary);
      }
      .toggle.collapsed {
        transform: rotate(-90deg);
      }
      .toggle.leaf {
        visibility: hidden;
      }

      .key {
        color: var(--sh-key);
        margin-right: 6px;
        cursor: pointer;
      }
      .key:hover {
        text-decoration: underline;
        opacity: 0.8;
      }

      .separator {
        color: var(--text-secondary);
        margin-right: 6px;
      }

      .value {
        cursor: pointer;
        padding: 0 4px;
        border-radius: 4px;
        transition: background 0.1s;
      }
      .value:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .string {
        color: var(--sh-string);
        word-break: break-all;
      }
      .number {
        color: var(--sh-number);
      }
      .boolean {
        color: var(--sh-boolean);
      }
      .null {
        color: var(--sh-null);
      }

      .meta {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 12px;
        margin-left: 8px;
      }

      .hidden-node {
        display: none;
      }
      .match-highlight {
        background: rgba(255, 212, 0, 0.3);
        color: #fff;
        border-radius: 2px;
      }

      /* Toast Notification */
      #toast {
        position: fixed;
        bottom: 32px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--panel);
        border: 1px solid var(--border);
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 0;
      }
      #toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      #toast.success i {
        color: var(--success);
      }
      #toast.error i {
        color: var(--error);
      }

      /* Loading State */
      .loader {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--accent);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: none;
      }
      .loading .loader {
        display: block;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        font-size: 14px;
        opacity: 0.5;
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
        }
        .container {
          padding: 16px;
          height: auto;
        }
        body {
          height: auto;
        }
        textarea {
          height: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <rect
              x="3"
              y="3"
              width="18"
              height="18"
              rx="6"
              fill="#1d9bf0"
              fill-opacity="0.2"
            />
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              stroke="#1d9bf0"
              stroke-width="2"
            />
            <path d="M14 2v6h6" stroke="#1d9bf0" stroke-width="2" />
            <path
              d="M8 13h8"
              stroke="#1d9bf0"
              stroke-width="2"
              stroke-linecap="round"
            />
            <path
              d="M8 17h5"
              stroke="#1d9bf0"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
          JSON Log Viewer
          <span class="pro-badge">PROMAX</span>
        </h1>
        <div style="display: flex; gap: 8px">
          <a
            href="https://github.com/doctoey/json-log-viewer"
            target="_blank"
            class="btn btn-secondary"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              style="margin-right: 6px"
            >
              <path
                d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            GitHub
          </a>
        </div>
      </header>

      <div class="main-grid">
        <!-- LEFT PANEL: INPUT -->
        <section class="panel">
          <div class="panel-header">
            <span class="panel-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              Input
            </span>
            <div class="flex gap-2" style="display: flex; gap: 8px">
              <div class="loader" id="spinner"></div>
              <button
                class="btn btn-secondary btn-icon"
                onclick="App.clear()"
                title="Clear"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div class="panel-body input-wrapper" id="dropZone">
            <textarea
              id="inputData"
              placeholder="Paste JSON, Drag & Drop file, or type here..."
            ></textarea>
            <div class="drop-overlay">
              <span style="color: var(--accent); font-weight: 600"
                >Drop JSON File Here</span
              >
            </div>

            <!-- Quick Actions Toolbar at bottom of input -->
            <div
              style="
                padding: 12px;
                border-top: 1px solid var(--border);
                background: rgba(0, 0, 0, 0.1);
                display: flex;
                gap: 8px;
                justify-content: flex-end;
              "
            >
              <button class="btn btn-secondary" onclick="App.formatInput()">
                Format
              </button>
              <button class="btn btn-primary" onclick="App.process()">
                Process
              </button>
            </div>
          </div>
        </section>

        <!-- RIGHT PANEL: OUTPUT -->
        <section class="panel">
          <div class="panel-header">
            <span class="panel-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M2 12h20M2 12l5-5m-5 5 5 5"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              Viewer
            </span>

            <div class="search-box">
              <input
                type="text"
                id="searchBox"
                placeholder="Filter keys or values..."
                onkeyup="Viewer.filter(this.value)"
              />
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <circle
                  cx="11"
                  cy="11"
                  r="8"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <path
                  d="m21 21-4.35-4.35"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
            </div>

            <div style="display: flex; gap: 8px">
              <button
                class="btn btn-secondary"
                onclick="Viewer.expandAll()"
                title="Expand All"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="Viewer.collapseAll()"
                title="Collapse All"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M4 14h6v6M20 10h-6V4M14 10l7-7M10 14l-7 7"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                </svg>
              </button>
              <button
                class="btn btn-secondary"
                onclick="Utils.copyToClipboard(App.rawJson)"
                title="Copy Raw JSON"
              >
                Copy JSON
              </button>
            </div>
          </div>

          <div class="panel-body" style="background: rgba(0, 0, 0, 0.1)">
            <div id="jsonTree" class="json-tree">
              <div class="empty-state">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  style="margin-bottom: 16px; opacity: 0.5"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                  <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" />
                  <path d="M16 13H8" stroke="currentColor" stroke-width="2" />
                  <path d="M16 17H8" stroke="currentColor" stroke-width="2" />
                  <path d="M10 9H8" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>Waiting for input...</span>
              </div>
            </div>
          </div>
          <div
            style="
              padding: 8px 16px;
              border-top: 1px solid var(--border);
              font-size: 12px;
              color: var(--text-secondary);
              display: flex;
              justify-content: space-between;
            "
          >
            <span id="pathDisplay">Path: (Click any item to copy path)</span>
            <span id="itemCount">0 items</span>
          </div>
        </section>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">
      <i id="toastIcon"></i>
      <span id="toastMsg">Notification</span>
    </div>

    <script>
      /**
       * Core Application Logic
       */
      const App = {
        rawJson: null,
        debounceTimer: null,

        init: () => {
          // Restore legacy state
          const saved = localStorage.getItem("jsonviewer_content");
          if (saved) {
            document.getElementById("inputData").value = saved;
            App.process();
          }

          // Drag & Drop
          const dropZone = document.getElementById("dropZone");
          const inputArea = document.getElementById("inputData");

          ["dragenter", "dragover", "dragleave", "drop"].forEach(
            (eventName) => {
              dropZone.addEventListener(
                eventName,
                (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                },
                false,
              );
            },
          );

          dropZone.addEventListener("dragenter", () =>
            dropZone.classList.add("drag-active"),
          );
          dropZone.addEventListener("dragleave", () =>
            dropZone.classList.remove("drag-active"),
          );
          dropZone.addEventListener("drop", (e) => {
            dropZone.classList.remove("drag-active");
            const file = e.dataTransfer.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (evt) => {
                inputArea.value = evt.target.result;
                App.process();
              };
              reader.readAsText(file);
            }
          });

          // Auto save
          inputArea.addEventListener("input", () => {
            clearTimeout(App.debounceTimer);
            App.debounceTimer = setTimeout(() => {
              localStorage.setItem("jsonviewer_content", inputArea.value);
              App.process();
            }, 800);
          });

          // Paste handler
          inputArea.addEventListener("paste", () => {
            setTimeout(() => App.process(), 50);
          });
        },

        process: () => {
          const input = document.getElementById("inputData").value.trim();
          if (!input) return;

          document.getElementById("spinner").style.display = "block";

          // Use timeout to allow UI to render spinner
          setTimeout(() => {
            try {
              let json = App.parse(input);
              // Apply deep parsing to expand nested JSON strings
              json = App.deepParse(json);

              App.rawJson = JSON.stringify(json, null, 2);
              Viewer.render(json);
              Utils.toast("Processed successfully", "success");
            } catch (e) {
              // Don't error hard on typing, just wait
              console.log("Parsing warning:", e);
            } finally {
              document.getElementById("spinner").style.display = "none";
            }
          }, 10);
        },

        formatInput: () => {
          const input = document.getElementById("inputData");
          try {
            let parsed = App.parse(input.value);
            parsed = App.deepParse(parsed);
            input.value = JSON.stringify(parsed, null, 2);
            App.process();
          } catch (e) {
            Utils.toast("Invalid JSON", "error");
          }
        },

        clear: () => {
          document.getElementById("inputData").value = "";
          localStorage.removeItem("jsonviewer_content");
          document.getElementById("jsonTree").innerHTML =
            '<div class="empty-state">Cleared</div>';
          document.getElementById("itemCount").textContent = "0 items";
        },

        // Robust Parser (same smart logic as V1, but cleaner)
        parse: (str) => {
          if (typeof str !== "string") return str;

          // 1. Try straightforward parse
          try {
            const parsed = JSON.parse(str);
            // Handle double-stringified JSON
            if (typeof parsed === "string") {
              try {
                return JSON.parse(parsed);
              } catch {
                return parsed;
              }
            }
            return parsed;
          } catch (e) {}

          // 2. Extract JSON from Log Line
          // Look for first { or [
          const start = str.search(/[{}\[]/);
          if (start > -1) {
            let stack = 0;
            for (let i = start; i < str.length; i++) {
              if (str[i] === "{" || str[i] === "[") stack++;
              if (str[i] === "}" || str[i] === "]") {
                stack--;
                if (stack === 0) {
                  const candidate = str.substring(start, i + 1);
                  try {
                    let res = JSON.parse(candidate);
                    if (typeof res === "string") {
                      try {
                        return JSON.parse(res);
                      } catch {
                        return res;
                      }
                    }
                    return res;
                  } catch (e2) {}
                  break;
                }
              }
            }
          }

          // 3. Fallback: Double quoted string?
          if (str.startsWith('"') && str.endsWith('"')) {
            try {
              return JSON.parse(JSON.parse(str));
            } catch (e3) {}
          }

          throw new Error("Unable to parse JSON");
        },

        // Recursively walk through object and try to parse strings that look like JSON
        deepParse: (data) => {
          if (typeof data === "string") {
            const trimmed = data.trim();
            if (trimmed.startsWith("{") || trimmed.startsWith("[")) {
              try {
                const parsed = JSON.parse(data);
                return App.deepParse(parsed);
              } catch (e) {
                return data;
              }
            }
            return data;
          }

          if (Array.isArray(data)) {
            return data.map((item) => App.deepParse(item));
          }

          if (typeof data === "object" && data !== null) {
            const newObj = {};
            for (const key in data) {
              newObj[key] = App.deepParse(data[key]);
            }
            return newObj;
          }

          return data;
        },
      };

      /**
       * Viewer & Filtering Logic
       */
      const Viewer = {
        rootEl: document.getElementById("jsonTree"),

        render: (data) => {
          Viewer.rootEl.innerHTML = "";

          if (data === null || data === undefined) {
            Viewer.rootEl.innerHTML = '<span class="null">null</span>';
            return;
          }

          const tree = Viewer.createNode(data, "root");
          Viewer.rootEl.appendChild(tree);

          // Stats
          const count = Array.isArray(data)
            ? data.length + " items"
            : Object.keys(data).length + " keys";
          document.getElementById("itemCount").textContent = count;
        },

        // Recursive node creator
        createNode: (data, path) => {
          const type = Array.isArray(data) ? "array" : typeof data;
          const isObject = type === "object" && data !== null;
          const isArray = type === "array";

          const container = document.createElement("div");
          container.className = "node";
          container.dataset.path = path; // For filtering

          // Value Node (Primitive)
          if (!isObject && !isArray) {
            const valEl = document.createElement("span");
            valEl.className = `value ${type}`;
            valEl.textContent =
              data === null ? "null" : type === "string" ? `"${data}"` : data;
            valEl.onclick = (e) => {
              e.stopPropagation();
              Utils.copyToClipboard(String(data));
              Utils.showPath(path);
            };
            // Allow text searching on this node
            container.dataset.filterText = String(data).toLowerCase();
            container.appendChild(valEl);
            return container;
          }

          // Complex Node (Object/Array)
          const isEmpty = isArray
            ? data.length === 0
            : Object.keys(data).length === 0;
          const startChar = isArray ? "[" : "{";
          const endChar = isArray ? "]" : "}";

          const line = document.createElement("div");
          line.className = "line";

          // Toggle Arrow
          const toggle = document.createElement("span");
          toggle.className = isEmpty ? "toggle leaf" : "toggle";
          toggle.textContent = "▼";
          if (!isEmpty) {
            toggle.onclick = (e) => {
              e.stopPropagation();
              const childrenDiv = container.querySelector(".children");
              const isCollapsed = toggle.classList.toggle("collapsed");
              childrenDiv.style.display = isCollapsed ? "none" : "flex";

              // Preview
              const preview = line.querySelector(".meta");
              if (preview)
                preview.style.display = isCollapsed ? "inline" : "none";
            };
          }
          line.appendChild(toggle);

          // Open Bracket
          const label = document.createElement("span");
          label.className = "key";
          label.textContent = startChar;
          label.onclick = (e) => {
            Utils.showPath(path);
            Utils.copyToClipboard(path);
          };
          line.appendChild(label);

          // Preview for collapsed state
          if (!isEmpty) {
            const preview = document.createElement("span");
            preview.className = "meta";
            preview.style.display = "none";
            const size = isArray ? data.length : Object.keys(data).length;
            preview.textContent = `${size} ${isArray ? "items" : "keys"}`;
            line.appendChild(preview);
          }

          container.appendChild(line);

          // Children Container
          if (!isEmpty) {
            const children = document.createElement("div");
            children.className = "children";
            children.style.display = "flex";
            children.style.flexDirection = "column";
            children.style.paddingLeft = "12px";
            children.style.borderLeft = "1px solid rgba(255,255,255,0.05)";

            // Render Children
            if (isArray) {
              data.forEach((item, idx) => {
                const childPath = `${path}[${idx}]`;
                const row = document.createElement("div");
                row.style.display = "flex";

                const childNode = Viewer.createNode(item, childPath);
                row.appendChild(childNode);
                children.appendChild(row);
              });
            } else {
              Object.entries(data).forEach(([key, val]) => {
                const safeKey = /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(key)
                  ? key
                  : `["${key}"]`;
                const childPath = path === "root" ? key : `${path}.${safeKey}`;

                const row = document.createElement("div");
                row.className = "node-row";
                row.style.display = "flex";

                // Key Label
                const keyEl = document.createElement("span");
                keyEl.className = "key";
                keyEl.textContent = `"${key}"`;
                keyEl.onclick = (e) => {
                  e.stopPropagation();
                  Utils.showPath(childPath);
                  Utils.copyToClipboard(key);
                };
                row.appendChild(keyEl);

                const sep = document.createElement("span");
                sep.className = "separator";
                sep.textContent = ":";
                row.appendChild(sep);

                const childNode = Viewer.createNode(val, childPath);

                // Add filter text for Object Keys
                childNode.dataset.keyText = key.toLowerCase();

                row.appendChild(childNode);
                children.appendChild(row);
              });
            }
            container.appendChild(children);
          }

          // Closing Bracket
          const closeLine = document.createElement("div");
          closeLine.style.paddingLeft = "12px";
          closeLine.textContent = endChar;
          if (!isEmpty) container.appendChild(closeLine);

          return container;
        },

        filter: (text) => {
          const query = text.toLowerCase().trim();
          const tree = document.getElementById("jsonTree");
          const allNodes = tree.querySelectorAll(".node, .node-row"); // rows contain keys

          // Remove highlights
          tree.querySelectorAll(".match-highlight").forEach((el) => {
            el.outerHTML = el.innerText;
          });

          if (!query) {
            allNodes.forEach((n) => n.classList.remove("hidden-node"));
            return;
          }

          // Simple strategy: Show node if it matches OR any of its children match
          // We can use CSS to hide, but we need to walk the tree.

          // 1. Reset
          allNodes.forEach((n) => n.classList.add("hidden-node"));

          // 2. Find matches
          const valueMatches = tree.querySelectorAll(".value");
          const keyMatches = tree.querySelectorAll(".key");

          // Check Values
          valueMatches.forEach((el) => {
            if (el.textContent.toLowerCase().includes(query)) {
              // Highlight
              // el.innerHTML = el.textContent.replace(new RegExp(query, 'gi'), m => `<span class="match-highlight">${m}</span>`);

              // Walk up and show parents
              let p = el.parentElement;
              while (p && p !== tree) {
                p.classList.remove("hidden-node");
                // also show siblings (key/separator)
                if (p.classList.contains("node-row")) p.style.display = "flex";
                p = p.parentElement;
              }
            }
          });

          // Check Keys
          keyMatches.forEach((el) => {
            if (el.textContent.toLowerCase().includes(query)) {
              let p = el.parentElement; // row or line
              while (p && p !== tree) {
                p.classList.remove("hidden-node");
                if (p.classList.contains("node-row")) p.style.display = "flex";
                p = p.parentElement;
              }

              // Also show the value node associated with this key node
              if (el.parentElement.classList.contains("node-row")) {
                const valNode = el.parentElement.querySelector(".node");
                if (valNode) valNode.classList.remove("hidden-node");
              }
            }
          });
        },

        expandAll: () => {
          document
            .querySelectorAll(".children")
            .forEach((el) => (el.style.display = "flex"));
          document.querySelectorAll(".toggle").forEach((el) => {
            el.classList.remove("collapsed");
            if (el.textContent === "▼") el.textContent = "▼";
          });
          document
            .querySelectorAll(".meta")
            .forEach((el) => (el.style.display = "none"));
        },

        collapseAll: () => {
          document
            .querySelectorAll(".children")
            .forEach((el) => (el.style.display = "none"));
          document.querySelectorAll(".toggle:not(.leaf)").forEach((el) => {
            el.classList.add("collapsed");
          });
          document
            .querySelectorAll(".meta")
            .forEach((el) => (el.style.display = "inline"));
        },
      };

      /**
       * Utils & Toast
       */
      const Utils = {
        toast: (msg, type = "success") => {
          const el = document.getElementById("toast");
          const icon = document.getElementById("toastIcon");
          const text = document.getElementById("toastMsg");

          el.className = `show ${type}`;
          text.textContent = msg;

          // clear prev
          clearTimeout(Utils._toastTimer);
          Utils._toastTimer = setTimeout(() => {
            el.className = "";
          }, 3000);
        },

        copyToClipboard: (text) => {
          if (!text) return;
          navigator.clipboard
            .writeText(text)
            .then(() => {
              Utils.toast("Copied to clipboard!");
            })
            .catch(() => Utils.toast("Failed to copy", "error"));
        },

        showPath: (path) => {
          const el = document.getElementById("pathDisplay");
          // Cleanup root
          let cleanPath = path.replace(/^root\./, "").replace(/^root/, "root");
          el.innerHTML = `Path: <span class="string">${cleanPath}</span>`;
        },
      };

      // Boot
      document.addEventListener("DOMContentLoaded", App.init);
    </script>
  </body>
</html>
